[33mcommit 769532729c5a3015881a503a891bd820c7e8d824[m
Author: engine-labs-app[bot] <140088366+engine-labs-app[bot]@users.noreply.github.com>
Date:   Fri Oct 31 15:45:23 2025 +0000

    feat(adblock): integrate all advanced anti-ad and smart controls from historical improvements
    
    Major update integrating advanced ad-blocking and user experience enhancements from the full script evolution. This change is needed to ensure robust ad-blocking on Twitch using the latest, most comprehensive techniques and to restore user-friendly playback behaviors.
    
    - Incorporates smart auto-unmute that respects manual mute with robust volume tracking
    - Vastly improves network, DOM, and GQL-based ad blocking with current ad patterns (Stream Display Ad, squeezeback, etc)
    - Enhances M3U8 cleaning, error handling, reload logic, and player restore
    - Optimizes performance with debounced observers and passive listeners
    - Adds new configuration and debug options, enabling state-of-the-art ad protection
    
    No breaking changes; all ordinary settings migrate seamlessly for users.

[1mdiff --git a/Twitch Adblock Fix & Force Source Quality.user.js b/Twitch Adblock Fix & Force Source Quality.user.js[m
[1mindex 44c4ba9..902690d 100644[m
[1m--- a/Twitch Adblock Fix & Force Source Quality.user.js[m	
[1m+++ b/Twitch Adblock Fix & Force Source Quality.user.js[m	
[36m@@ -1,8 +1,8 @@[m
 // ==UserScript==[m
 // @name         Twitch Adblock Ultimate[m
 // @namespace    TwitchAdblockUltimate[m
[31m-// @version      30.6.3[m
[31m-// @description  Twitch adblock that modifies network requests to prevent ads and player errors.[m
[32m+[m[32m// @version      31.1.2[m
[32m+[m[32m// @description  Twitch ad-blocking with injected ad protection, and performance optimizations[m
 // @author       ShmidtS[m
 // @match        https://www.twitch.tv/*[m
 // @match        https://m.twitch.tv/*[m
[36m@@ -27,65 +27,198 @@[m
 (function() {[m
     'use strict';[m
 [m
[32m+[m[32m    const defaultForceUnmute = GM_getValue('TTV_AdBlock_ForceUnmute', true);[m
[32m+[m
     const CONFIG = {[m
[31m-        SCRIPT_VERSION: '30.6.3',[m
[32m+[m[32m        SCRIPT_VERSION: '31.1.2',[m
         SETTINGS: {[m
             FORCE_MAX_QUALITY: GM_getValue('TTV_AdBlock_ForceMaxQuality', true),[m
             ATTEMPT_DOM_AD_REMOVAL: GM_getValue('TTV_AdBlock_AttemptDOMAdRemoval', true),[m
             HIDE_COOKIE_BANNER: GM_getValue('TTV_AdBlock_HideCookieBanner', true),[m
             ENABLE_AUTO_RELOAD: GM_getValue('TTV_AdBlock_EnableAutoReload', true),[m
[31m-            FORCE_UNMUTE: GM_getValue('TTV_AdBlock_ForceUnmute', true),[m
[32m+[m[32m            FORCE_UNMUTE: defaultForceUnmute,[m
[32m+[m[32m            SMART_UNMUTE: GM_getValue('TTV_AdBlock_SmartUnmute', defaultForceUnmute),[m
[32m+[m[32m            RESPECT_USER_MUTE: GM_getValue('TTV_AdBlock_RespectUserMute', true),[m
             REMOVE_AD_PLACEHOLDER: GM_getValue('TTV_AdBlock_RemoveAdPlaceholder', true),[m
[32m+[m[32m            AGGRESSIVE_AD_BLOCK: GM_getValue('TTV_AdBlock_AggressiveBlock', true),[m
         },[m
         DEBUG: {[m
[31m-            SHOW_ERRORS: GM_getValue('TTV_AdBlock_ShowErrorsInConsole', true),[m
[32m+[m[32m            SHOW_ERRORS: GM_getValue('TTV_AdBlock_ShowErrorsInConsole', false),[m
             CORE: GM_getValue('TTV_AdBlock_Debug_Core', false),[m
[31m-            PLAYER_MONITOR: GM_getValue('TTV_AdBlock_Debug_PlayerMon', true),[m
[31m-            M3U8_CLEANING: GM_getValue('TTV_AdBlock_Debug_M3U8', true),[m
[31m-            GQL_MODIFY: GM_getValue('TTV_AdBlock_Debug_GQL', true),[m
[32m+[m[32m            PLAYER_MONITOR: GM_getValue('TTV_AdBlock_Debug_PlayerMon', false),[m
[32m+[m[32m            M3U8_CLEANING: GM_getValue('TTV_AdBlock_Debug_M3U8', false),[m
[32m+[m[32m            GQL_MODIFY: GM_getValue('TTV_AdBlock_Debug_GQL', false),[m
             NETWORK_BLOCKING: GM_getValue('TTV_AdBlock_Debug_NetBlock', false),[m
         },[m
         ADVANCED: {[m
[31m-            RELOAD_STALL_THRESHOLD_MS: GM_getValue('TTV_AdBlock_StallThresholdMs', 10000),[m
[31m-            RELOAD_BUFFERING_THRESHOLD_MS: GM_getValue('TTV_AdBlock_BufferingThresholdMs', 25000),[m
[31m-            RELOAD_COOLDOWN_MS: GM_getValue('TTV_AdBlock_ReloadCooldownMs', 15000),[m
[31m-            MAX_RELOADS_PER_SESSION: GM_getValue('TTV_AdBlock_MaxReloadsPerSession', 3),[m
[31m-            RELOAD_ON_ERROR_CODES: GM_getValue('TTV_AdBlock_ReloadOnErrorCodes', "1000,2000,3000,4000,5000")[m
[32m+[m[32m            RELOAD_STALL_THRESHOLD_MS: GM_getValue('TTV_AdBlock_StallThresholdMs', 12000),[m
[32m+[m[32m            RELOAD_BUFFERING_THRESHOLD_MS: GM_getValue('TTV_AdBlock_BufferingThresholdMs', 30000),[m
[32m+[m[32m            RELOAD_COOLDOWN_MS: GM_getValue('TTV_AdBlock_ReloadCooldownMs', 20000),[m
[32m+[m[32m            MAX_RELOADS_PER_SESSION: GM_getValue('TTV_AdBlock_MaxReloadsPerSession', 2),[m
[32m+[m[32m            RELOAD_ON_ERROR_CODES: GM_getValue('TTV_AdBlock_ReloadOnErrorCodes', "3000,4000,5000")[m
             .split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n)),[m
[31m-            IVS_ERROR_THRESHOLD: 4000,[m
[32m+[m[32m            IVS_ERROR_THRESHOLD: 5000,[m
             PIP_RETRY_ATTEMPTS: 3,[m
[31m-            PIP_RETRY_DELAY_MS: 800,[m
[32m+[m[32m            PIP_RETRY_DELAY_MS: 1000,[m
[32m+[m[32m            OBSERVER_THROTTLE_MS: 450,[m
         },[m
     };[m
 [m
[31m-    const LOG_PREFIX = `[TTV ADBLOCK ULT v${CONFIG.SCRIPT_VERSION}]`;[m
[32m+[m[32m    const LOG_PREFIX = `[TTV ADBLOCK ENH v${CONFIG.SCRIPT_VERSION}]`;[m
     const GQL_URL = 'https://gql.twitch.tv/gql';[m
     const TWITCH_MANIFEST_PATH_REGEX = /\.m3u8($|\?)/i;[m
[32m+[m
     const AD_URL_KEYWORDS_BLOCK = [[m
[31m-        'edge.ads.twitch.tv', 'nat.min.js', 'twitchAdServer.js', 'player-ad-aws.js',[m
[31m-        'googlesyndication.com', 'doubleclick.net', 'adnxs.com', 'amazon-adsystem.com',[m
[31m-        'ads.ttvnw.net', 'ad.twitch.tv', 'sentry.io', 'scorecardresearch.com',[m
[31m-        'amazon-ivs', 'ivs-player', // Added IVS-related keywords[m
[32m+[m[32m        'edge.ads.twitch.tv',[m
[32m+[m[32m        'nat.min.js',[m
[32m+[m[32m        'twitchadserver.js',[m
[32m+[m[32m        'player-ad-aws.js',[m
[32m+[m[32m        'googlesyndication.com',[m
[32m+[m[32m        'doubleclick.net',[m
[32m+[m[32m        'adnxs.com',[m
[32m+[m[32m        'amazon-adsystem.com',[m
[32m+[m[32m        'ads.ttvnw.net',[m
[32m+[m[32m        'ad.twitch.tv',[m
[32m+[m[32m        'sentry.io',[m
[32m+[m[32m        'scorecardresearch.com',[m
[32m+[m[32m        'amazon-ivs-ads',[m
[32m+[m[32m        'ivs-player-ads',[m
[32m+[m[32m        'ad-delivery',[m
[32m+[m[32m        'ad-beacon',[m
[32m+[m[32m        'ad-insertion',[m
[32m+[m[32m        'ad-decisioning',[m
[32m+[m[32m        'api.sprig.com',[m
[32m+[m[32m        'sprig.com/sdk',[m
[32m+[m[32m        'ads-api.twitch.tv',[m
[32m+[m[32m        'gql.twitch.tv/?op=streamdisplayad',[m
[32m+[m[32m        'stream-display-ad',[m
     ];[m
[32m+[m
     const AD_DOM_SELECTORS = [[m
[31m-        '.ad-interrupt-screen', '.video-player__ad-info-container', '.player-ad-notice',[m
[31m-        'div[data-test-selector="ad-banner-default-text-area"]', '.persistent-player__ad-container',[m
[31m-        '[data-a-target="advertisement-notice"]', 'div[data-a-target="ax-overlay"]',[m
[31m-        '[data-test-selector*="sad-overlay"]', 'div[data-a-target*="ad-block-nag"]',[m
[31m-        '.ad-break-ui-container', '[data-a-target="ad-banner"]', '.promoted-content-card',[m
[31m-        '.video-ad-display__container', '[role="advertisement"]', 'div[data-a-target="player-ad-overlay"]',[m
[31m-        '.commercial-break-in-progress', '[data-test-selector="commercial-break-in-progress"]',[m
[31m-        '.twitch-ad-break-placeholder', '.ad-break-overlay', '.player-overlay.ad-break',[m
[31m-        '.video-player__overlay[data-test-selector*="ad"]', '.picture-in-picture-player',[m
[31m-        '.pip-player-container', '[data-a-target="player-pip"]', '.ivs-ad-container', // Added IVS ad selector[m
[32m+[m[32m        '.ad-interrupt-screen',[m
[32m+[m[32m        '.video-player__ad-info-container',[m
[32m+[m[32m        '.player-ad-notice',[m
[32m+[m[32m        'div[data-test-selector="ad-banner-default-text-area"]',[m
[32m+[m[32m        '.persistent-player__ad-container',[m
[32m+[m[32m        '[data-a-target="advertisement-notice"]',[m
[32m+[m[32m        'div[data-a-target="ax-overlay"]',[m
[32m+[m[32m        '[data-a-target="outstream-ax-overlay"]',[m
[32m+[m[32m        '[data-test-selector*="sad-overlay"]',[m
[32m+[m[32m        'div[data-a-target*="ad-block-nag"]',[m
[32m+[m[32m        '.ad-break-ui-container',[m
[32m+[m[32m        '[data-a-target="ad-banner"]',[m
[32m+[m[32m        '.promoted-content-card',[m
[32m+[m[32m        '.video-ad-display__container',[m
[32m+[m[32m        '[role="advertisement"]',[m
[32m+[m[32m        'div[data-a-target="player-ad-overlay"]',[m
[32m+[m[32m        '.commercial-break-in-progress',[m
[32m+[m[32m        '[data-test-selector="commercial-break-in-progress"]',[m
[32m+[m[32m        '.twitch-ad-break-placeholder',[m
[32m+[m[32m        '.ad-break-overlay',[m
[32m+[m[32m        '.player-overlay.ad-break',[m
[32m+[m[32m        '.video-player__overlay[data-test-selector*="ad"]',[m
[32m+[m[32m        '.picture-in-picture-player',[m
[32m+[m[32m        '.pip-player-container',[m
[32m+[m[32m        '[data-a-target="player-pip"]',[m
[32m+[m[32m        '.ivs-ad-container',[m
[32m+[m[32m        '.ivs-ad-overlay',[m
[32m+[m[32m        '.ivs-ad-wrapper',[m
[32m+[m[32m        '[class*="AdOverlay"]',[m
[32m+[m[32m        '[class*="AdBanner"]',[m
[32m+[m[32m        '[class*="AdContainer"]',[m
[32m+[m[32m        '[class*="ad-overlay"]',[m
[32m+[m[32m        '[class*="ad-banner"]',[m
[32m+[m[32m        '[class*="ad-container"]',[m
[32m+[m[32m        '.video-player__stream-info-overlay',[m
[32m+[m[32m        '[data-test-selector="sda-wrapper"]',[m
[32m+[m[32m        '[data-test-selector="sda-container"]',[m
[32m+[m[32m        '[data-test-selector="sda-transform"]',[m
[32m+[m[32m        '[data-test-selector="sda-frame"]',[m
[32m+[m[32m        '.stream-display-ad__wrapper',[m
[32m+[m[32m        '.stream-display-ad__container',[m
[32m+[m[32m        '.stream-display-ad__transform-container',[m
[32m+[m[32m        '.stream-display-ad__frame',[m
[32m+[m[32m        '[class*="stream-display-ad"]',[m
[32m+[m[32m        '[class*="squeezeback"]',[m
[32m+[m[32m        '.stream-display-ad__wrapper_squeezeback',[m
[32m+[m[32m        '.stream-display-ad__container_squeezeback',[m
[32m+[m[32m        '.stream-display-ad__transform-container_squeezeback',[m
[32m+[m[32m        '.stream-display-ad__frame_squeezeback',[m
[32m+[m[32m        '#stream-lowerthird',[m
[32m+[m[32m        '.squeezeback-accessibility-frame',[m
         ...(CONFIG.SETTINGS.HIDE_COOKIE_BANNER ? ['.consent-banner'] : []),[m
     ];[m
[32m+[m
     const AD_DATERANGE_KEYWORDS = [[m
[31m-        'AD-ID=', 'CUE-OUT', 'SCTE35', 'Twitch-Ad-Signal', 'Twitch-Prefetch',[m
[31m-        'Twitch-Ads', 'X-TWITCH-AD', 'EXT-X-TWITCH-INFO', 'EXT-X-ASSET',[m
[31m-        'EXT-X-IVS-AD', 'IVS-AD-MARKER', // Added IVS-specific ad markers[m
[32m+[m[32m        'AD-ID=',[m
[32m+[m[32m        'CUE-OUT',[m
[32m+[m[32m        'CUE-IN',[m
[32m+[m[32m        'SCTE35',[m
[32m+[m[32m        'Twitch-Ad-Signal',[m
[32m+[m[32m        'Twitch-Prefetch',[m
[32m+[m[32m        'Twitch-Ads',[m
[32m+[m[32m        'Twitch-Ad-Url',[m
[32m+[m[32m        'Twitch-Ad-Pod',[m
[32m+[m[32m        'X-TWITCH-AD',[m
[32m+[m[32m        'EXT-X-TWITCH-INFO',[m
[32m+[m[32m        'EXT-X-ASSET',[m
[32m+[m[32m        'EXT-X-IVS-AD',[m
[32m+[m[32m        'EXT-X-TWITCH-AD',[m
[32m+[m[32m        'EXT-X-TWITCH-CM',[m
[32m+[m[32m        'STREAM-DISPLAY-AD',[m
[32m+[m[32m        'SQUEEZEBACK',[m
[32m+[m[32m        'IVS-AD-MARKER',[m
[32m+[m[32m        'TWITCH-AD-ROLL',[m
[32m+[m[32m        'ADVERTISEMENT',[m
[32m+[m[32m        'STITCHED-AD',[m
[32m+[m[32m        'PREROLL',[m
[32m+[m[32m        'MIDROLL',[m
[32m+[m[32m        'AD-SERVER',[m
[32m+[m[32m        'AD-MANIFEST',[m
[32m+[m[32m        'AD-URL',[m
     ];[m
[31m-    const PLACEHOLDER_TEXT = 'Commercial break in progress';[m
[32m+[m
[32m+[m[32m    const PLACEHOLDER_TEXTS = [[m
[32m+[m[32m        'Commercial break in progress',[m
[32m+[m[32m        'The channel is currently displaying a commercial',[m
[32m+[m[32m        'Ad break in progress',[m
[32m+[m[32m        'Advertisement',[m
[32m+[m[32m        'Ð ÐµÐºÐ»Ð°Ð¼Ð°',[m
[32m+[m[32m        'Ð ÐµÐºÐ»Ð°Ð¼Ð½Ð°Ñ Ð²ÑÑ‚Ð°Ð²ÐºÐ°',[m
[32m+[m[32m        'Werbeunterbrechung',[m
[32m+[m[32m    ];[m
[32m+[m
[32m+[m[32m    const GQL_BLOCKED_OPERATIONS = new Set([[m
[32m+[m[32m        'StreamDisplayAd',[m
[32m+[m[32m        'StreamDisplayAdMetadata',[m
[32m+[m[32m        'StreamDisplayAdEvent',[m
[32m+[m[32m        'SDAAdMetadata',[m
[32m+[m[32m        'SDAAdRequest',[m
[32m+[m[32m        'SDARegulationBanner',[m
[32m+[m[32m        'SDARegisterDisplayAd',[m
[32m+[m[32m        'PersistentStreamDisplayAdContext',[m
[32m+[m[32m        'AdIntegrityBanner',[m
[32m+[m[32m        'CommercialBreakRequest',[m
[32m+[m[32m        'CommercialBreakStatus',[m
[32m+[m[32m        'AdRequestSurface',[m
[32m+[m[32m    ]);[m
[32m+[m
[32m+[m[32m    const shouldBlockGqlOperation = (operationName) => {[m
[32m+[m[32m        if (!operationName || typeof operationName !== 'string') {[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m[32m        if (GQL_BLOCKED_OPERATIONS.has(operationName)) {[m
[32m+[m[32m            return true;[m
[32m+[m[32m        }[m
[32m+[m[32m        const name = operationName.toLowerCase();[m
[32m+[m[32m        return name.includes('streamdisplayad') ||[m
[32m+[m[32m            name.includes('sda') ||[m
[32m+[m[32m            name.includes('commercialbreak') ||[m
[32m+[m[32m            name.includes('adrequest') ||[m
[32m+[m[32m            name.includes('admetadata');[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const createEmptyGqlResponse = () => ({ data: {}, errors: [] });[m
 [m
     let hooksInstalled = false;[m
     let adRemovalObserver = null;[m
[36m@@ -93,6 +226,14 @@[m
     let videoElement = null;[m
     let lastReloadTimestamp = 0;[m
     let reloadCount = 0;[m
[32m+[m[32m    let userMutedManually = false;[m
[32m+[m[32m    let lastUserVolumeChange = 0;[m
[32m+[m[32m    let adDetected = false;[m
[32m+[m[32m    let originalVideoParent = null;[m
[32m+[m[32m    let lastKnownVolume = 0.5;[m
[32m+[m[32m    let scriptAdjustingVolume = false;[m
[32m+[m[32m    const USER_VOLUME_CHANGE_COOLDOWN_MS = 4000;[m
[32m+[m[32m    const PREFERRED_SUPPORTED_CODECS = ['av1', 'h265', 'h264'];[m
     const originalFetch = unsafeWindow.fetch;[m
 [m
     const logError = (s, m, ...a) => CONFIG.DEBUG.SHOW_ERRORS && console.error(`${LOG_PREFIX} [${s}] ERROR:`, m, ...a);[m
[36m@@ -100,71 +241,254 @@[m
     const logDebug = (s, m, ...a) => CONFIG.DEBUG.CORE && console.info(`${LOG_PREFIX} [${s}] DEBUG:`, m, ...a);[m
     const logTrace = (f, s, m, ...a) => f && console.debug(`${LOG_PREFIX} [${s}] TRACE:`, m, ...a);[m
 [m
[32m+[m[32m    const debounce = (fn, wait) => {[m
[32m+[m[32m        let timeout = null;[m
[32m+[m[32m        return (...args) => {[m
[32m+[m[32m            clearTimeout(timeout);[m
[32m+[m[32m            timeout = setTimeout(() => fn(...args), wait);[m
[32m+[m[32m        };[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const withVolumeGuard = (fn) => {[m
[32m+[m[32m        scriptAdjustingVolume = true;[m
[32m+[m[32m        try {[m
[32m+[m[32m            fn();[m
[32m+[m[32m        } finally {[m
[32m+[m[32m            setTimeout(() => {[m
[32m+[m[32m                scriptAdjustingVolume = false;[m
[32m+[m[32m            }, 200);[m
[32m+[m[32m        }[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const hasRecentUserVolumeChange = () => ([m
[32m+[m[32m        !!(lastUserVolumeChange && (Date.now() - lastUserVolumeChange) < USER_VOLUME_CHANGE_COOLDOWN_MS)[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    const shouldAutoUnmute = () => {[m
[32m+[m[32m        if (!CONFIG.SETTINGS.FORCE_UNMUTE || !CONFIG.SETTINGS.SMART_UNMUTE) {[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (CONFIG.SETTINGS.RESPECT_USER_MUTE && userMutedManually) {[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (hasRecentUserVolumeChange()) {[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return true;[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const attemptAutoUnmute = (reason) => {[m
[32m+[m[32m        if (!videoElement || !shouldAutoUnmute()) {[m
[32m+[m[32m            if (CONFIG.DEBUG.PLAYER_MONITOR) {[m
[32m+[m[32m                if (userMutedManually) {[m
[32m+[m[32m                    logTrace(true, 'AudioGuard', `Skipping auto-unmute (${reason}) due to user mute`);[m
[32m+[m[32m                } else if (hasRecentUserVolumeChange()) {[m
[32m+[m[32m                    logTrace(true, 'AudioGuard', `Skipping auto-unmute (${reason}) due to recent user volume change`);[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m            return;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const targetVolume = lastKnownVolume > 0.05 ? lastKnownVolume : 0.5;[m
[32m+[m[32m        const wasMuted = videoElement.muted;[m
[32m+[m[32m        const wasLowVolume = videoElement.volume <= 0.001;[m
[32m+[m
[32m+[m[32m        withVolumeGuard(() => {[m
[32m+[m[32m            if (videoElement.muted) {[m
[32m+[m[32m                videoElement.muted = false;[m
[32m+[m[32m            }[m
[32m+[m[32m            if (videoElement.volume <= 0.001) {[m
[32m+[m[32m                videoElement.volume = targetVolume;[m
[32m+[m[32m            }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        if (wasMuted || wasLowVolume) {[m
[32m+[m[32m            lastKnownVolume = videoElement.volume > 0.05 ? videoElement.volume : targetVolume;[m
[32m+[m[32m            logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'AudioGuard', `Auto-unmuted (${reason}) to volume ${lastKnownVolume.toFixed(2)}`);[m
[32m+[m[32m        }[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const normalizeSupportedCodecs = (existing) => {[m
[32m+[m[32m        const codecs = Array.isArray(existing)[m
[32m+[m[32m        ? existing.filter(codec => typeof codec === 'string' && codec.trim())[m
[32m+[m[32m        : [];[m
[32m+[m[32m        const unique = new Set();[m
[32m+[m[32m        codecs.forEach(codec => unique.add(codec));[m
[32m+[m[32m        PREFERRED_SUPPORTED_CODECS.forEach(codec => unique.add(codec));[m
[32m+[m[32m        return Array.from(unique);[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const adjustPlaybackAccessTokenPayload = (payload) => {[m
[32m+[m[32m        if (!payload || typeof payload !== 'object' || !payload.variables || typeof payload.variables !== 'object') {[m
[32m+[m[32m            return false;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const { variables } = payload;[m
[32m+[m[32m        let updated = false;[m
[32m+[m
[32m+[m[32m        if (variables.playerType !== 'embed') {[m
[32m+[m[32m            variables.playerType = 'embed';[m
[32m+[m[32m            updated = true;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (!variables.platform || variables.platform !== 'web') {[m
[32m+[m[32m            variables.platform = 'web';[m
[32m+[m[32m            updated = true;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const normalizedCodecs = normalizeSupportedCodecs(variables.supportedCodecs);[m
[32m+[m[32m        if (!Array.isArray(variables.supportedCodecs) ||[m
[32m+[m[32m            variables.supportedCodecs.length !== normalizedCodecs.length ||[m
[32m+[m[32m            variables.supportedCodecs.some((codec, index) => normalizedCodecs[index] !== codec)) {[m
[32m+[m[32m            variables.supportedCodecs = normalizedCodecs;[m
[32m+[m[32m            updated = true;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (variables.isVod === false && variables.playerBackend !== 'mediaplayer') {[m
[32m+[m[32m            variables.playerBackend = 'mediaplayer';[m
[32m+[m[32m            updated = true;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (Object.prototype.hasOwnProperty.call(variables, 'adblock')) {[m
[32m+[m[32m            delete variables.adblock;[m
[32m+[m[32m            updated = true;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return updated;[m
[32m+[m[32m    };[m
[32m+[m
     const fetchOverride = async (input, init) => {[m
         const requestUrl = input instanceof Request ? input.url : String(input);[m
         const requestUrlLower = requestUrl.toLowerCase();[m
 [m
[31m-        // 1. Block known ad-related URLs[m
         if (AD_URL_KEYWORDS_BLOCK.some(k => requestUrlLower.includes(String(k).toLowerCase()))) {[m
[31m-            logTrace(CONFIG.DEBUG.NETWORK_BLOCKING, 'Block URL', requestUrl);[m
[31m-            return new Response(null, { status: 403, statusText: `Blocked by TTV AdBlock` });[m
[32m+[m[32m            logTrace(CONFIG.DEBUG.NETWORK_BLOCKING, 'Network', `Blocked fetch ${requestUrl}`);[m
[32m+[m[32m            return new Response(null, { status: 204, statusText: 'Blocked by TTV Adblock Enhanced' });[m
         }[m
 [m
[31m-        // 2. Intercept and modify GraphQL requests[m
         if (requestUrl === GQL_URL) {[m
             try {[m
[31m-                if (init && init.body) {[m
[31m-                    const originalBodyText = typeof init.body === 'string' ? init.body : await (new Request(input, init)).text();[m
[32m+[m[32m                let originalBodyText = null;[m
[32m+[m
[32m+[m[32m                if (typeof init?.body === 'string') {[m
[32m+[m[32m                    originalBodyText = init.body;[m
[32m+[m[32m                } else if (input instanceof Request) {[m
[32m+[m[32m                    originalBodyText = await input.clone().text();[m
[32m+[m[32m                } else if (init && init.body) {[m
[32m+[m[32m                    originalBodyText = await (new Request(requestUrl, init)).text();[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                if (originalBodyText) {[m
                     const originalBody = JSON.parse(originalBodyText);[m
 [m
[31m-                    if (originalBody.operationName === 'PlaybackAccessToken') {[m
[31m-                        logDebug('fetchOverride', 'Intercepting PlaybackAccessToken, setting playerType to "site" and ad parameters.');[m
[31m-                        originalBody.variables.playerType = 'site'; // Changed to 'site' to align with Twitch's latest player[m
[31m-                        originalBody.variables.disableAds = true; // Explicitly request ad-free stream[m
[31m-                        originalBody.variables.isAdBlockPresent = false; // Spoof adblock detection[m
[31m-[m
[31m-                        const newInit = { ...init, body: JSON.stringify(originalBody) };[m
[31m-                        return originalFetch(input, newInit);[m
[31m-                    } else if (originalBody.operationName === 'ShoutoutHighlightServiceQuery') {[m
[31m-                        logDebug('fetchOverride', 'Skipping ShoutoutHighlightServiceQuery to avoid server errors.');[m
[31m-                        return new Response(JSON.stringify({ data: {}, errors: [] }), {[m
[31m-                            status: 200,[m
[31m-                            headers: { 'Content-Type': 'application/json' }[m
[32m+[m[32m                    const adjustPlayback = (payload) => {[m
[32m+[m[32m                        if (!payload || typeof payload !== 'object') {[m
[32m+[m[32m                            return false;[m
[32m+[m[32m                        }[m
[32m+[m[32m                        const updated = adjustPlaybackAccessTokenPayload(payload);[m
[32m+[m[32m                        if (updated) {[m
[32m+[m[32m                            logTrace(CONFIG.DEBUG.GQL_MODIFY, 'GQL', 'Adjusted PlaybackAccessToken payload');[m
[32m+[m[32m                        }[m
[32m+[m[32m                        return updated;[m
[32m+[m[32m                    };[m
[32m+[m
[32m+[m[32m                    if (Array.isArray(originalBody)) {[m
[32m+[m[32m                        let modified = false;[m
[32m+[m[32m                        let blockedCount = 0;[m
[32m+[m
[32m+[m[32m                        originalBody.forEach(payload => {[m
[32m+[m[32m                            if (payload?.operationName) {[m
[32m+[m[32m                                if (shouldBlockGqlOperation(payload.operationName)) {[m
[32m+[m[32m                                    blockedCount++;[m
[32m+[m[32m                                }[m
[32m+[m[32m                                if (payload.operationName === 'PlaybackAccessToken' && adjustPlayback(payload)) {[m
[32m+[m[32m                                    modified = true;[m
[32m+[m[32m                                }[m
[32m+[m[32m                            }[m
                         });[m
[32m+[m
[32m+[m[32m                        if (blockedCount === originalBody.length && blockedCount > 0) {[m
[32m+[m[32m                            logTrace(CONFIG.DEBUG.GQL_MODIFY, 'GQL', 'Blocked ad-related GQL batch operation');[m
[32m+[m[32m                            const stub = originalBody.map(() => createEmptyGqlResponse());[m
[32m+[m[32m                            return new Response(JSON.stringify(stub), {[m
[32m+[m[32m                                status: 200,[m
[32m+[m[32m                                headers: { 'Content-Type': 'application/json' }[m
[32m+[m[32m                            });[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        if (modified) {[m
[32m+[m[32m                            const newInit = { ...(init || {}), body: JSON.stringify(originalBody) };[m
[32m+[m[32m                            return originalFetch(input, newInit);[m
[32m+[m[32m                        }[m
[32m+[m[32m                    } else if (originalBody && typeof originalBody === 'object') {[m
[32m+[m[32m                        if (originalBody.operationName && shouldBlockGqlOperation(originalBody.operationName)) {[m
[32m+[m[32m                            logTrace(CONFIG.DEBUG.GQL_MODIFY, 'GQL', `Blocked ad-related GQL operation: ${originalBody.operationName}`);[m
[32m+[m[32m                            return new Response(JSON.stringify(createEmptyGqlResponse()), {[m
[32m+[m[32m                                status: 200,[m
[32m+[m[32m                                headers: { 'Content-Type': 'application/json' }[m
[32m+[m[32m                            });[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        if (originalBody.operationName === 'ShoutoutHighlightServiceQuery') {[m
[32m+[m[32m                            return new Response(JSON.stringify(createEmptyGqlResponse()), {[m
[32m+[m[32m                                status: 200,[m
[32m+[m[32m                                headers: { 'Content-Type': 'application/json' }[m
[32m+[m[32m                            });[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        if (originalBody.operationName === 'VideoPlayerStreamInfoOverlayChannel') {[m
[32m+[m[32m                            return new Response(JSON.stringify({ data: { user: null }, errors: [] }), {[m
[32m+[m[32m                                status: 200,[m
[32m+[m[32m                                headers: { 'Content-Type': 'application/json' }[m
[32m+[m[32m                            });[m
[32m+[m[32m                        }[m
[32m+[m
[32m+[m[32m                        if (originalBody.operationName === 'PlaybackAccessToken' && adjustPlayback(originalBody)) {[m
[32m+[m[32m                            const newInit = { ...(init || {}), body: JSON.stringify(originalBody) };[m
[32m+[m[32m                            return originalFetch(input, newInit);[m
[32m+[m[32m                        }[m
                     }[m
                 }[m
             } catch (e) {[m
[31m-                logTrace(CONFIG.DEBUG.GQL_MODIFY, 'GQL request modification failed, proceeding with original.', e);[m
[32m+[m[32m                logTrace(CONFIG.DEBUG.GQL_MODIFY, 'GQL', 'PlaybackAccessToken modification failed', e);[m
             }[m
         }[m
 [m
[31m-        // 3. Intercept and clean M3U8 playlists[m
         if (TWITCH_MANIFEST_PATH_REGEX.test(requestUrl) && requestUrlLower.includes('usher.ttvnw.net')) {[m
             try {[m
                 const response = await originalFetch(input, init);[m
                 if (response && response.ok) {[m
                     const manifestText = await response.text();[m
[31m-                    const { cleanedText, adsFound } = parseAndCleanM3U8(manifestText, requestUrl);[m
[32m+[m[32m                    const { cleanedText, adsFound, adSegments } = parseAndCleanM3U8(manifestText, requestUrl);[m
 [m
                     if (adsFound) {[m
[31m-                        logDebug('fetchOverride', 'Cleaned m3u8 playlist (ads removed):', requestUrl);[m
[32m+[m[32m                        adDetected = true;[m
[32m+[m[32m                        logTrace(CONFIG.DEBUG.M3U8_CLEANING, 'M3U8', `Removed ${adSegments} ad segments`);[m
[32m+[m
                         const newHeaders = new Headers(response.headers);[m
                         newHeaders.delete('Content-Length');[m
[32m+[m[32m                        newHeaders.set('X-Adblock-Cleaned', 'true');[m
[32m+[m
                         return new Response(cleanedText, {[m
                             status: response.status,[m
                             statusText: response.statusText,[m
                             headers: newHeaders[m
                         });[m
                     }[m
[32m+[m
                     return new Response(manifestText, {[m
                         status: response.status,[m
                         statusText: response.statusText,[m
                         headers: response.headers[m
                     });[m
                 }[m
[32m+[m
                 return response;[m
             } catch (e) {[m
[31m-                logWarn('fetchOverride', 'Error fetching/cleaning m3u8, falling back to original fetch.', e);[m
[32m+[m[32m                logWarn('Network', 'Failed to clean M3U8 manifest', e);[m
             }[m
         }[m
 [m
[36m@@ -172,194 +496,483 @@[m
     };[m
 [m
     const injectCSS = () => {[m
[31m-        const css = `${AD_DOM_SELECTORS.join(',\n')} { display: none !important; opacity: 0 !important; visibility: hidden !important; z-index: -1000 !important; } video { display: block !important; width: 100% !important; height: auto !important; }`;[m
[32m+[m[32m        const css = `[m
[32m+[m[32m${AD_DOM_SELECTORS.join(',\n')} {[m
[32m+[m[32m    display: none !important;[m
[32m+[m[32m    opacity: 0 !important;[m
[32m+[m[32m    visibility: hidden !important;[m
[32m+[m[32m    z-index: -9999 !important;[m
[32m+[m[32m    position: absolute !important;[m
[32m+[m[32m    width: 0 !important;[m
[32m+[m[32m    height: 0 !important;[m
[32m+[m[32m    pointer-events: none !important;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.video-player__container {[m
[32m+[m[32m    position: relative !important;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m.video-player__overlay[data-test-selector*="ad"]:not([data-a-target*="player-controls"]) {[m
[32m+[m[32m    pointer-events: none !important;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mvideo {[m
[32m+[m[32m    display: block !important;[m
[32m+[m[32m    width: 100% !important;[m
[32m+[m[32m    height: 100% !important;[m
[32m+[m[32m    object-fit: contain !important;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Ensure player controls remain interactive */[m
[32m+[m[32m[data-a-target*="player-controls"],[m
[32m+[m[32m[data-a-target*="player-overlay-click-handler"],[m
[32m+[m[32m.player-controls,[m
[32m+[m[32m.player-controls__left-control-group,[m
[32m+[m[32m.player-controls__right-control-group,[m
[32m+[m[32mbutton[data-a-target*="player"],[m
[32m+[m[32m.player-button,[m
[32m+[m[32m[class*="player-controls"],[m
[32m+[m[32m[class*="PlayerControls"],[m
[32m+[m[32m[class*="player-overlay-background"],[m
[32m+[m[32m.video-player__overlay-background {[m
[32m+[m[32m    pointer-events: auto !important;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* Optimize rendering */[m
[32m+[m[32m.video-player__container,[m
[32m+[m[32m.video-player {[m
[32m+[m[32m    will-change: transform !important;[m
[32m+[m[32m    transform: translateZ(0);[m
[32m+[m[32m}[m
[32m+[m[32m        `;[m
[32m+[m
         try {[m
             GM_addStyle(css);[m
[32m+[m[32m            logTrace(CONFIG.DEBUG.CORE, 'Init', 'CSS injected');[m
         } catch (e) {[m
[31m-            logWarn('injectCSS', 'GM_addStyle failed', e);[m
[32m+[m[32m            logWarn('Init', 'CSS injection failed', e);[m
         }[m
     };[m
 [m
     const forceMaxQuality = () => {[m
         try {[m
             Object.defineProperties(document, {[m
[31m-                'visibilityState': { get: () => 'visible', configurable: true },[m
[31m-                'hidden': { get: () => false, configurable: true }[m
[32m+[m[32m                visibilityState: { get: () => 'visible', configurable: true },[m
[32m+[m[32m                hidden: { get: () => false, configurable: true },[m
[32m+[m[32m                webkitHidden: { get: () => false, configurable: true },[m
[32m+[m[32m                mozHidden: { get: () => false, configurable: true },[m
[32m+[m[32m                msHidden: { get: () => false, configurable: true },[m
             });[m
             document.addEventListener('visibilitychange', e => e.stopImmediatePropagation(), true);[m
[32m+[m[32m            logTrace(CONFIG.DEBUG.CORE, 'Init', 'Page visibility overridden for quality');[m
         } catch (e) {[m
[31m-            logWarn('forceMaxQuality', 'Could not override visibilityState', e);[m
[32m+[m[32m            logWarn('Init', 'Unable to override visibility API', e);[m
         }[m
     };[m
 [m
     const parseAndCleanM3U8 = (m3u8Text, url = 'N/A') => {[m
[31m-        if (!m3u8Text || typeof m3u8Text !== 'string') return { cleanedText: m3u8Text, adsFound: false };[m
[32m+[m[32m        if (!m3u8Text || typeof m3u8Text !== 'string') {[m
[32m+[m[32m            return { cleanedText: m3u8Text, adsFound: false, adSegments: 0 };[m
[32m+[m[32m        }[m
[32m+[m
         let adsFound = false;[m
[32m+[m[32m        let adSegments = 0;[m
         const keywordUpper = AD_DATERANGE_KEYWORDS.map(k => String(k).toUpperCase());[m
[31m-[m
         const lines = m3u8Text.split('\n');[m
[31m-        const cleanLines = lines.filter(line => {[m
[31m-            if (!line) return true;[m
[32m+[m[32m        const cleanLines = [];[m
[32m+[m[32m        let skipNextSegment = false;[m
[32m+[m[32m        let inAdBlock = false;[m
[32m+[m
[32m+[m[32m        for (let i = 0; i < lines.length; i++) {[m
[32m+[m[32m            const line = lines[i];[m
[32m+[m[32m            if (!line) {[m
[32m+[m[32m                cleanLines.push(line);[m
[32m+[m[32m                continue;[m
[32m+[m[32m            }[m
[32m+[m
             const trimmed = line.trim();[m
             const upper = trimmed.toUpperCase();[m
 [m
[31m-            if (upper.startsWith('#EXT-X-DATERANGE') || upper.startsWith('#EXT-X-CUE-OUT') ||[m
[31m-                upper.startsWith('#EXT-X-CUE-IN') || upper.startsWith('#EXT-X-IVS-AD')) {[m
[32m+[m[32m            if (skipNextSegment) {[m
[32m+[m[32m                skipNextSegment = false;[m
[32m+[m[32m                adSegments++;[m
[32m+[m[32m                continue;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (upper.startsWith('#EXT-X-DATERANGE')) {[m
[32m+[m[32m                if (keywordUpper.some(k => upper.includes(k))) {[m
[32m+[m[32m                    adsFound = true;[m
[32m+[m[32m                    inAdBlock = true;[m
[32m+[m[32m                    continue;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (upper.startsWith('#EXT-X-CUE-OUT') || (upper.startsWith('#EXTINF') && inAdBlock)) {[m
                 adsFound = true;[m
[31m-                return false;[m
[32m+[m[32m                if (upper.startsWith('#EXTINF')) {[m
[32m+[m[32m                    skipNextSegment = true;[m
[32m+[m[32m                }[m
[32m+[m[32m                continue;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (upper.startsWith('#EXT-X-CUE-IN')) {[m
[32m+[m[32m                adsFound = true;[m
[32m+[m[32m                inAdBlock = false;[m
[32m+[m[32m                continue;[m
             }[m
[32m+[m
             if (keywordUpper.some(k => upper.includes(k))) {[m
                 adsFound = true;[m
[31m-                return false;[m
[32m+[m[32m                if (upper.startsWith('#EXTINF')) {[m
[32m+[m[32m                    skipNextSegment = true;[m
[32m+[m[32m                }[m
[32m+[m[32m                continue;[m
             }[m
[31m-            return true;[m
[31m-        });[m
 [m
[31m-        return { cleanedText: adsFound ? cleanLines.join('\n') : m3u8Text, adsFound };[m
[32m+[m[32m            cleanLines.push(line);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m            cleanedText: adsFound ? cleanLines.join('\n') : m3u8Text,[m
[32m+[m[32m            adsFound,[m
[32m+[m[32m            adSegments,[m
[32m+[m[32m        };[m
     };[m
 [m
     const removeDOMAdElements = () => {[m
         if (!CONFIG.SETTINGS.ATTEMPT_DOM_AD_REMOVAL) return;[m
[31m-        if (adRemovalObserver) adRemovalObserver.disconnect();[m
[31m-        adRemovalObserver = new MutationObserver(() => {[m
[31m-            try {[m
[31m-                let placeholderDetected = false;[m
[31m-                AD_DOM_SELECTORS.forEach(sel => {[m
[31m-                    try {[m
[31m-                        document.querySelectorAll(sel).forEach(el => el.remove());[m
[31m-                    } catch (e) {}[m
[31m-                });[m
[31m-                const elements = document.querySelectorAll('div,span,p,section');[m
[31m-                elements.forEach(el => {[m
[31m-                    try {[m
[31m-                        const txt = (el.textContent || '').trim();[m
[31m-                        if (!txt) return;[m
[31m-                        if (txt.toLowerCase().includes(PLACEHOLDER_TEXT.toLowerCase())) {[m
[31m-                            placeholderDetected = true;[m
[31m-                            el.remove();[m
[32m+[m
[32m+[m[32m        const runCleanup = () => {[m
[32m+[m[32m            const root = videoElement?.closest('.video-player__container') || document.body || document.documentElement;[m
[32m+[m[32m            if (!root) return;[m
[32m+[m
[32m+[m[32m            let removedElements = 0;[m
[32m+[m[32m            let placeholderDetected = false;[m
[32m+[m[32m            let removedStreamDisplayAd = false;[m
[32m+[m
[32m+[m[32m            AD_DOM_SELECTORS.forEach(selector => {[m
[32m+[m[32m                try {[m
[32m+[m[32m                    const matches = root.querySelectorAll(selector);[m
[32m+[m[32m                    if (matches.length) {[m
[32m+[m[32m                        matches.forEach(el => {[m
[32m+[m[32m                            if (el && el.parentNode && !el.closest('[data-a-target*="player-controls"]')) {[m
[32m+[m[32m                                if (!removedStreamDisplayAd) {[m
[32m+[m[32m                                    removedStreamDisplayAd = el.matches('[data-test-selector^="sda"]') ||[m
[32m+[m[32m                                        el.matches('[class*="stream-display-ad"]') ||[m
[32m+[m[32m                                        el.matches('[class*="squeezeback"]') ||[m
[32m+[m[32m                                        el.id === 'stream-lowerthird';[m
[32m+[m[32m                                }[m
[32m+[m[32m                                el.remove();[m
[32m+[m[32m                                removedElements++;[m
[32m+[m[32m                            }[m
[32m+[m[32m                        });[m
[32m+[m[32m                    }[m
[32m+[m[32m                } catch (e) { /* ignore CSS errors */ }[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (CONFIG.SETTINGS.REMOVE_AD_PLACEHOLDER) {[m
[32m+[m[32m                const textContainers = root.querySelectorAll('div, span, p, section, article');[m
[32m+[m[32m                textContainers.forEach(node => {[m
[32m+[m[32m                    if (!node || !node.textContent) return;[m
[32m+[m[32m                    if (node.closest('[data-a-target*="player-controls"]')) return;[m
[32m+[m[32m                    const text = node.textContent.trim().toLowerCase();[m
[32m+[m[32m                    if (!text) return;[m
[32m+[m[32m                    if (PLACEHOLDER_TEXTS.some(ph => text.includes(ph.toLowerCase()))) {[m
[32m+[m[32m                        placeholderDetected = true;[m
[32m+[m[32m                        if (node.parentNode) {[m
[32m+[m[32m                            node.remove();[m
[32m+[m[32m                            removedElements++;[m
                         }[m
[31m-                    } catch (e) {}[m
[32m+[m[32m                    }[m
                 });[m
[31m-                if (placeholderDetected && videoElement) {[m
[31m-                    try {[m
[31m-                        videoElement.muted = false;[m
[31m-                        videoElement.volume = 1.0;[m
[31m-                        videoElement.play().catch(() => {});[m
[31m-                        if (document.pictureInPictureElement) {[m
[31m-                            document.exitPictureInPicture().catch(() => {});[m
[31m-                        }[m
[31m-                        videoElement.style.width = '100%';[m
[31m-                        videoElement.style.height = '100%';[m
[31m-                    } catch (e) {}[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (removedStreamDisplayAd) {[m
[32m+[m[32m                restoreVideoFromAd('stream display ad cleanup');[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (placeholderDetected) {[m
[32m+[m[32m                restoreVideoFromAd('placeholder cleanup');[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (removedElements && CONFIG.DEBUG.PLAYER_MONITOR) {[m
[32m+[m[32m                logTrace(true, 'DOM', `Removed ${removedElements} ad elements`);[m
[32m+[m[32m            }[m
[32m+[m[32m        };[m
[32m+[m
[32m+[m[32m        const debouncedCleanup = debounce(runCleanup, CONFIG.ADVANCED.OBSERVER_THROTTLE_MS);[m
[32m+[m
[32m+[m[32m        if (adRemovalObserver) {[m
[32m+[m[32m            adRemovalObserver.disconnect();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        adRemovalObserver = new MutationObserver((mutations) => {[m
[32m+[m[32m            let shouldClean = false;[m
[32m+[m[32m            for (const mutation of mutations) {[m
[32m+[m[32m                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {[m
[32m+[m[32m                    shouldClean = true;[m
[32m+[m[32m                    break;[m
[32m+[m[32m                }[m
[32m+[m[32m                if (mutation.type === 'attributes' && ['class', 'data-a-target', 'data-test-selector', 'style'].includes(mutation.attributeName)) {[m
[32m+[m[32m                    shouldClean = true;[m
[32m+[m[32m                    break;[m
                 }[m
[31m-            } catch (e) {[m
[31m-                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'adRemovalObserver callback error', e);[m
[32m+[m[32m            }[m
[32m+[m[32m            if (shouldClean) {[m
[32m+[m[32m                debouncedCleanup();[m
             }[m
         });[m
[32m+[m
         const target = document.body || document.documentElement;[m
[31m-        if (target) adRemovalObserver.observe(target, { childList: true, subtree: true, attributes: true });[m
[32m+[m[32m        if (target) {[m
[32m+[m[32m            adRemovalObserver.observe(target, {[m
[32m+[m[32m                childList: true,[m
[32m+[m[32m                subtree: true,[m
[32m+[m[32m                attributes: true,[m
[32m+[m[32m                attributeFilter: ['style', 'class', 'data-a-target', 'data-test-selector'],[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        runCleanup();[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    const restoreVideoFromAd = (reason = 'ad cleanup') => {[m
[32m+[m[32m        if (!videoElement) return;[m
[32m+[m
[32m+[m[32m        attemptAutoUnmute(reason);[m
[32m+[m
[32m+[m[32m        if (videoElement.paused) {[m
[32m+[m[32m            videoElement.play().catch(() => {});[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (document.pictureInPictureElement && document.pictureInPictureElement !== videoElement) {[m
[32m+[m[32m            document.exitPictureInPicture().catch(() => {});[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        if (originalVideoParent && videoElement.parentElement !== originalVideoParent) {[m
[32m+[m[32m            try {[m
[32m+[m[32m                originalVideoParent.appendChild(videoElement);[m
[32m+[m[32m            } catch (e) {}[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        videoElement.style.removeProperty('display');[m
[32m+[m[32m        videoElement.style.removeProperty('opacity');[m
[32m+[m[32m        videoElement.style.removeProperty('width');[m
[32m+[m[32m        videoElement.style.removeProperty('height');[m
[32m+[m
[32m+[m[32m        const videoContainer = videoElement.closest('.video-player__container');[m
[32m+[m[32m        if (videoContainer) {[m
[32m+[m[32m            videoContainer.style.removeProperty('transform');[m
[32m+[m[32m            videoContainer.style.removeProperty('max-height');[m
[32m+[m[32m            videoContainer.style.removeProperty('min-height');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const persistentPlayer = videoElement.closest('.persistent-player');[m
[32m+[m[32m        if (persistentPlayer) {[m
[32m+[m[32m            persistentPlayer.style.removeProperty('transform');[m
[32m+[m[32m            persistentPlayer.style.removeProperty('max-height');[m
[32m+[m[32m            persistentPlayer.style.removeProperty('height');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const videoLayout = videoElement.closest('[data-test-selector="video-player__video-layout"]');[m
[32m+[m[32m        if (videoLayout) {[m
[32m+[m[32m            videoLayout.style.removeProperty('transform');[m
[32m+[m[32m            videoLayout.style.removeProperty('max-height');[m
[32m+[m[32m            videoLayout.style.removeProperty('min-height');[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        adDetected = false;[m
     };[m
 [m
     const triggerReload = (reason) => {[m
         if (!CONFIG.SETTINGS.ENABLE_AUTO_RELOAD) return;[m
[32m+[m
         const now = Date.now();[m
[31m-        if (reloadCount >= CONFIG.ADVANCED.MAX_RELOADS_PER_SESSION ||[m
[31m-            now - lastReloadTimestamp < CONFIG.ADVANCED.RELOAD_COOLDOWN_MS) {[m
[32m+[m[32m        if (reloadCount >= CONFIG.ADVANCED.MAX_RELOADS_PER_SESSION || (now - lastReloadTimestamp) < CONFIG.ADVANCED.RELOAD_COOLDOWN_MS) {[m
[32m+[m[32m            logTrace(CONFIG.DEBUG.CORE, 'Reload', `Skipped reload (${reason})`);[m
             return;[m
         }[m
[31m-        lastReloadTimestamp = now;[m
[32m+[m
         reloadCount++;[m
[31m-        logWarn('triggerReload', 'Reload triggered because', reason);[m
[31m-        unsafeWindow.location.reload();[m
[32m+[m[32m        lastReloadTimestamp = now;[m
[32m+[m[32m        logWarn('Reload', `Reloading page (#${reloadCount}) due to ${reason}`);[m
[32m+[m[32m        setTimeout(() => unsafeWindow.location.reload(), 100);[m
     };[m
 [m
     const setupVideoPlayerMonitor = () => {[m
[31m-        if (videoPlayerObserver) videoPlayerObserver.disconnect();[m
[32m+[m[32m        if (videoPlayerObserver) {[m
[32m+[m[32m            videoPlayerObserver.disconnect();[m
[32m+[m[32m        }[m
[32m+[m
         const attachListeners = (vid) => {[m
[31m-            if (!vid || vid._adblock_listeners_attached) return;[m
[32m+[m[32m            if (!vid || vid._ttvAdblockListeners) return;[m
[32m+[m
[32m+[m[32m            originalVideoParent = vid.parentElement;[m
[32m+[m[32m            if (vid.volume > 0.05) {[m
[32m+[m[32m                lastKnownVolume = vid.volume;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m
[32m+[m[32m            if (!vid._ttvInitialState) {[m
[32m+[m[32m                vid._ttvInitialState = true;[m
[32m+[m[32m                if (CONFIG.SETTINGS.FORCE_UNMUTE && CONFIG.SETTINGS.SMART_UNMUTE) {[m
[32m+[m[32m                    setTimeout(() => {[m
[32m+[m[32m                        if (videoElement === vid && !userMutedManually) {[m
[32m+[m[32m                            attemptAutoUnmute('initial setup');[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }, 1000);[m
[32m+[m
[32m+[m[32m                    setTimeout(() => {[m
[32m+[m[32m                        if (videoElement === vid && !userMutedManually && (vid.muted || vid.volume <= 0.001)) {[m
[32m+[m[32m                            attemptAutoUnmute('initial setup retry');[m
[32m+[m[32m                        }[m
[32m+[m[32m                    }, 2500);[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m
             let stallTimer = null;[m
             let ivsErrorTimer = null;[m
[32m+[m[32m            let waitingTimer = null;[m
[32m+[m
[32m+[m[32m            vid.addEventListener('volumechange', () => {[m
[32m+[m[32m                const now = Date.now();[m
[32m+[m[32m                if (scriptAdjustingVolume) {[m
[32m+[m[32m                    if (vid.volume > 0.05) {[m
[32m+[m[32m                        lastKnownVolume = vid.volume;[m
[32m+[m[32m                    }[m
[32m+[m[32m                    logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'AudioGuard', 'Volume changed by script');[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const isMuted = vid.muted || vid.volume <= 0.001;[m
[32m+[m[32m                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'AudioGuard', `User volume change: muted=${isMuted}, volume=${vid.volume}`);[m
[32m+[m
[32m+[m[32m                if (isMuted) {[m
[32m+[m[32m                    userMutedManually = true;[m
[32m+[m[32m                    logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'AudioGuard', 'User manually muted');[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    userMutedManually = false;[m
[32m+[m[32m                    if (vid.volume > 0.05) {[m
[32m+[m[32m                        lastKnownVolume = vid.volume;[m
[32m+[m[32m                    }[m
[32m+[m[32m                    logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'AudioGuard', 'User manually unmuted');[m
[32m+[m[32m                }[m
[32m+[m[32m                lastUserVolumeChange = now;[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
             vid.addEventListener('stalled', () => {[m
[32m+[m[32m                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'Video', 'Playback stalled');[m
                 if (stallTimer) clearTimeout(stallTimer);[m
[31m-                stallTimer = setTimeout(() => triggerReload('Stall timeout'), CONFIG.ADVANCED.RELOAD_STALL_THRESHOLD_MS);[m
[32m+[m[32m                stallTimer = setTimeout(() => triggerReload('stall timeout'), CONFIG.ADVANCED.RELOAD_STALL_THRESHOLD_MS);[m
                 document.querySelectorAll('.commercial-break-in-progress,[data-test-selector="commercial-break-in-progress"]').forEach(el => el.remove());[m
[31m-                try {[m
[31m-                    vid.muted = false;[m
[32m+[m[32m                if (vid.paused) {[m
                     vid.play().catch(() => {});[m
[31m-                } catch (e) {}[m
[31m-            });[m
[32m+[m[32m                }[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
             vid.addEventListener('playing', () => {[m
                 if (stallTimer) clearTimeout(stallTimer);[m
[31m-                if (CONFIG.SETTINGS.FORCE_UNMUTE && vid.muted) {[m
[31m-                    vid.muted = false;[m
[32m+[m[32m                if (waitingTimer) clearTimeout(waitingTimer);[m
[32m+[m[32m                if (adDetected) {[m
[32m+[m[32m                    attemptAutoUnmute('playing');[m
[32m+[m[32m                    adDetected = false;[m
                 }[m
[31m-            });[m
[32m+[m[32m                if (vid.volume > 0.05 && !scriptAdjustingVolume) {[m
[32m+[m[32m                    lastKnownVolume = vid.volume;[m
[32m+[m[32m                }[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
             vid.addEventListener('loadeddata', () => {[m
[31m-                if (CONFIG.SETTINGS.FORCE_UNMUTE) {[m
[31m-                    vid.muted = false;[m
[32m+[m[32m                if (adDetected) {[m
[32m+[m[32m                    attemptAutoUnmute('loadeddata');[m
[32m+[m[32m                    adDetected = false;[m
                 }[m
[31m-            });[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
             vid.addEventListener('error', (e) => {[m
[31m-                try {[m
[31m-                    const code = e.target?.error?.code;[m
[31m-                    if (code && (CONFIG.ADVANCED.RELOAD_ON_ERROR_CODES.includes(code) ||[m
[31m-                                 (e.message && (e.message.includes('IVS') || e.message.includes('InvalidCharacterError'))))) {[m
[31m-                        if (ivsErrorTimer) clearTimeout(ivsErrorTimer);[m
[31m-                        ivsErrorTimer = setTimeout(() => triggerReload(`IVS/Player error code ${code}`), CONFIG.ADVANCED.IVS_ERROR_THRESHOLD);[m
[31m-                    }[m
[31m-                } catch (err) {}[m
[31m-                document.querySelectorAll('.commercial-break-in-progress,[data-test-selector="commercial-break-in-progress"]').forEach(el => el.remove());[m
[31m-                try {[m
[31m-                    vid.muted = false;[m
[31m-                    vid.play().catch(() => {});[m
[31m-                } catch (e) {}[m
[31m-            });[m
[31m-            vid.addEventListener('volumechange', () => {[m
[31m-                if (CONFIG.SETTINGS.FORCE_UNMUTE && (vid.volume === 0 || vid.muted)) {[m
[31m-                    vid.muted = false;[m
[31m-                    vid.volume = 1;[m
[32m+[m[32m                const code = e?.target?.error?.code;[m
[32m+[m[32m                const message = e?.target?.error?.message || '';[m
[32m+[m[32m                logError('Video', `Player error (code=${code}, message=${message})`);[m
[32m+[m[32m                if (code && (CONFIG.ADVANCED.RELOAD_ON_ERROR_CODES.includes(code) || message.includes('IVS') || message.includes('InvalidCharacter'))) {[m
[32m+[m[32m                    if (ivsErrorTimer) clearTimeout(ivsErrorTimer);[m
[32m+[m[32m                    ivsErrorTimer = setTimeout(() => triggerReload(`error ${code}`), CONFIG.ADVANCED.IVS_ERROR_THRESHOLD);[m
                 }[m
[32m+[m[32m                document.querySelectorAll('.commercial-break-in-progress,[data-test-selector="commercial-break-in-progress"]').forEach(el => el.remove());[m
             });[m
[32m+[m
             vid.addEventListener('waiting', () => {[m
[31m-                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'Video waiting, attempting to resume');[m
[31m-                try {[m
[31m-                    vid.play().catch(() => {});[m
[31m-                } catch (e) {}[m
[31m-            });[m
[31m-            vid._adblock_listeners_attached = true;[m
[32m+[m[32m                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'Video', 'Buffering...');[m
[32m+[m[32m                if (waitingTimer) clearTimeout(waitingTimer);[m
[32m+[m[32m                waitingTimer = setTimeout(() => {[m
[32m+[m[32m                    if (vid.readyState < 3) {[m
[32m+[m[32m                        vid.play().catch(() => {});[m
[32m+[m[32m                    }[m
[32m+[m[32m                }, CONFIG.ADVANCED.RELOAD_BUFFERING_THRESHOLD_MS);[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
[32m+[m[32m            vid.addEventListener('canplay', () => {[m
[32m+[m[32m                if (waitingTimer) clearTimeout(waitingTimer);[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
[32m+[m[32m            vid.addEventListener('seeking', () => {[m
[32m+[m[32m                if (stallTimer) clearTimeout(stallTimer);[m
[32m+[m[32m            }, { passive: true });[m
[32m+[m
[32m+[m[32m            vid._ttvAdblockListeners = true;[m
         };[m
[31m-        const findAndAttach = () => {[m
[32m+[m
[32m+[m[32m        const debouncedAttach = debounce(() => {[m
             const currentVideo = document.querySelector('video');[m
             if (currentVideo && currentVideo !== videoElement) {[m
                 videoElement = currentVideo;[m
                 attachListeners(videoElement);[m
[32m+[m[32m                logTrace(CONFIG.DEBUG.PLAYER_MONITOR, 'Video', 'Attached to new video element');[m
             }[m
[31m-        };[m
[31m-        videoPlayerObserver = new MutationObserver(findAndAttach);[m
[32m+[m[32m        }, 250);[m
[32m+[m
[32m+[m[32m        videoPlayerObserver = new MutationObserver(() => debouncedAttach());[m
[32m+[m
         const target = document.body || document.documentElement;[m
         if (target) {[m
             videoPlayerObserver.observe(target, { childList: true, subtree: true });[m
[31m-            findAndAttach();[m
         }[m
[32m+[m
[32m+[m[32m        debouncedAttach();[m
     };[m
 [m
[31m-    function installHooks() {[m
[32m+[m[32m    const installHooks = () => {[m
         if (hooksInstalled) return;[m
         hooksInstalled = true;[m
[32m+[m
         try {[m
             unsafeWindow.fetch = fetchOverride;[m
             logTrace(CONFIG.DEBUG.CORE, 'Init', 'Fetch override installed');[m
         } catch (e) {[m
[31m-            logWarn('installHooks', 'Could not override fetch', e);[m
[32m+[m[32m            logWarn('Init', 'Failed to override fetch', e);[m
         }[m
[31m-    }[m
[32m+[m[32m    };[m
 [m
     const initialize = () => {[m
[32m+[m[32m        logDebug('Init', 'Starting Twitch Adblock Ultimate Enhanced');[m
         installHooks();[m
         injectCSS();[m
[31m-        if (CONFIG.SETTINGS.FORCE_MAX_QUALITY) forceMaxQuality();[m
[32m+[m[32m        if (CONFIG.SETTINGS.FORCE_MAX_QUALITY) {[m
[32m+[m[32m            forceMaxQuality();[m
[32m+[m[32m        }[m
         removeDOMAdElements();[m
         setupVideoPlayerMonitor();[m
[32m+[m
[32m+[m[32m        setInterval(() => {[m
[32m+[m[32m            if (adDetected && videoElement && CONFIG.SETTINGS.AGGRESSIVE_AD_BLOCK) {[m
[32m+[m[32m                restoreVideoFromAd('periodic watchdog');[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            if (videoElement && CONFIG.SETTINGS.FORCE_UNMUTE && CONFIG.SETTINGS.SMART_UNMUTE && !userMutedManually) {[m
[32m+[m[32m                if (videoElement.muted || videoElement.volume <= 0.001) {[m
[32m+[m[32m                    attemptAutoUnmute('periodic check');[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }, 2000);[m
     };[m
 [m
     if (document.readyState === 'loading') {[m
